# 📦 Project Package

## Состав архива
- `business_logic.md` — бизнес-логика (что делает приложение и зачем).
- `technical_logic.md` — техническая логика (как реализовать приложение).
- `progpedia.md` — краткий справочник по модулям.
- `data_flow.md` — схема обмена данными между частями системы.

## Как использовать
1. Сначала прочитайте **business_logic.md**, чтобы понять цели и правила работы приложения.
2. Затем откройте **technical_logic.md** — он описывает архитектуру, структуру модулей и лучшие практики разработки.
3. По мере развития проекта сверяйтесь с **progpedia.md** и **data_flow.md**, чтобы выдерживать стиль и формат обмена данными.
4. Передавайте эти файлы агенту (например, GPT-Codex) для поэтапной генерации кода:
   - Сначала реализуйте базу данных.
   - Потом веб-интерфейс (Flask).
   - Далее — интеграцию с Outlook и Telegram.
   - В конце — автоматизацию проверок и тестирование.

## Режимы запуска
- **Веб-интерфейс (разработка)**: `python -m project_package.project.app`. Запускает встроенный сервер Flask на `http://127.0.0.1:5000`; перед дачей доступа пользователям обновите `SECRET_KEY` и отключите `debug` в `app.py`.
- **Веб-интерфейс (продакшн)**: запустите WSGI-сервер, например `gunicorn --bind 0.0.0.0:8000 project_package.project.app:app`. Для Windows подойдёт `waitress-serve --listen=0.0.0.0:8000 project_package.project.app:app`. Повесьте nginx/Apache/IIS как обратный прокси и настройте автозапуск (systemd, Task Scheduler).
- **Проверка почты вручную**: `python -m project_package.project.mail_checker` (опция `--fake` подставит тестовые письма).
- **Проверка задержек вручную**: `python -m project_package.project.notifier --minutes 60` (добавьте `--dry-run`, если нужно увидеть текст без отправки в Telegram).
- **Пакетный запуск обоих заданий**: `python -m project_package.runner` (флаги `--fake-mail`, `--dry-run`, `--minutes`, `--skip-mail`, `--skip-notifier`).

## Автоматизация проверок
Вместо встроенного планировщика используются отдельные CLI-команды — их удобно запускать через cron (Linux) или Task Scheduler (Windows).

- Проверка почты и обновление статусов:
  ```bash
  python -m project_package.project.mail_checker
  ```
  Опция `--fake` включает встроенные тестовые письма (для отладки без Outlook).

- Напоминания о задержках:
  ```bash
  python -m project_package.project.notifier --minutes 60
  ```
  Опция `--dry-run` печатает сообщения без отправки в Telegram.

- Комплексный запуск обоих заданий:
  ```bash
  python -m project_package.runner
  ```
  Используйте, если хотите одной командой обновить статусы и отправить уведомления.

Примеры расписания:
- Linux (cron, каждые 10 минут):
  ```cron
  */10 * * * * /usr/bin/python -m project_package.runner >> /var/log/omis-runner.log 2>&1
  ```
- Windows Task Scheduler: создайте задание с действием `python -m project_package.runner` и повтором каждые 10 минут.

## Общие рекомендации
- Развивайте проект по шагам: сначала простая версия (MVP), потом улучшения.
- Храните все секретные данные (токены, пароли) только в `config.py` или переменных окружения.
- Всегда комментируйте код и используйте `logging` для отслеживания работы.
- Начинайте тестирование на тестовых письмах и тестовом Telegram-чате, прежде чем подключать боевую систему.
- Держите проект структурированным: один модуль — одна ответственность.
- По мере роста нагрузки можно заменить SQLite на PostgreSQL.

---
Удачи в разработке! 🚀

### Автозапуск через systemd (Linux)
1. Скопируйте `ops/systemd/omis-runner.service` и `ops/systemd/omis-runner.timer` в `/etc/systemd/system/`.
2. Создайте `/etc/default/omis` на основе `ops/systemd/omis-runner.env.example` — пропишите путь к проекту (`OMIS_ROOT`) и интерпретатор (`OMIS_PYTHON`), при необходимости добавьте переменные Telegram.
3. Перезагрузите конфигурацию: `sudo systemctl daemon-reload`.
4. Включите таймер: `sudo systemctl enable --now omis-runner.timer`.
5. Проверяйте статус через `systemctl list-timers` и `journalctl -u omis-runner.service`.

### Автозапуск через Task Scheduler (Windows)
1. Создайте действие `python -m project_package.runner` (при необходимости укажите полный путь к Python/venv). Укажите каталог запуска (рабочая папка проекта), чтобы скрипт видел `ops/testing` и базу данных.
2. Задайте триггер с повтором каждые 10 минут и отметьте запуск независимо от входа пользователя. При перезагрузке сервера задание стартует автоматически.
3. В дополнительных параметрах включите завершение задачи при превышении лимита (например, 5 минут) и настройте повтор при ошибке. Это защищает от зависших запросов к почте/Telegram.
4. Следите за логами через историю Task Scheduler и журнал приложения; при необходимости перенаправьте стандартный вывод в файл (пример: `python -m project_package.runner >> C:\logs\omis-runner.log 2>&1`).
5. Если требуется собственный профиль окружения (переменные `OMIS_TELEGRAM_TOKEN` и т.п.), добавьте перед командой запуск `.bat`, который экспортирует переменные и стартует Python.

### Пакетный запуск
- Команда `python -m project_package.runner` последовательно запускает обработку почты и проверку задержек, поэтому её удобно использовать и вручную, и в автоматическом расписании.
- По флагу `--dry-run` можно отключить отправку в Telegram, сохранив логи для диагностики; используйте `--minutes` для проверки разных порогов.
- Для повторного использования сценариев запускайте `python -m project_package.scenario_runner --scenario <имя>` (см. `ops/testing/scenarios.json`) — это позволяет тестировать цепочку перед боевым выполнением.
- Если нужно временно пропустить интеграцию с почтой или уведомления, используйте `python -m project_package.runner --skip-mail` или `--skip-notifier`.


